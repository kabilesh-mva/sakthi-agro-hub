<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase Storage - Sakthi Agro</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 40px 20px;
            color: #fff;
        }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { font-size: 28px; margin-bottom: 10px; color: #4ade80; }
        .subtitle { color: #94a3b8; margin-bottom: 30px; }
        .card {
            background: #1e293b;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .card h2 {
            font-size: 18px;
            color: #e2e8f0;
            margin-bottom: 15px;
        }
        .btn {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            margin: 10px 0;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .result {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Consolas', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success { border-color: #22c55e; }
        .result.error { border-color: #ef4444; }
        .result pre { white-space: pre-wrap; word-break: break-all; }
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin: 10px 0;
        }
        .status.success { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
        .status.error { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .status.pending { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: block;
            color: #94a3b8;
            margin-bottom: 8px;
            font-size: 14px;
        }
        .input-group input[type="file"] {
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            width: 100%;
        }
        .config {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        .config-title {
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .config-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
            font-size: 13px;
        }
        .config-item:last-child { border-bottom: none; }
        .config-label { color: #94a3b8; }
        .config-value { color: #e2e8f0; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Supabase Storage Diagnostic Tool</h1>
        <p class="subtitle">Test your storage connection and find the exact error</p>

        <div class="card">
            <h2>üìã Your Configuration</h2>
            <div class="config">
                <div class="config-title">Current Settings</div>
                <div class="config-item">
                    <span class="config-label">Project ID:</span>
                    <span class="config-value" id="project-id">Loading...</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Bucket Name:</span>
                    <span class="config-value">product-images</span>
                </div>
                <div class="config-item">
                    <span class="config-label">Max File Size:</span>
                    <span class="config-value">5MB</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>üß™ Test 1: Check Bucket Access</h2>
            <button class="btn" onclick="testBucket()">
                üîç Test Bucket Connection
            </button>
            <div id="bucket-status"></div>
            <div id="bucket-result" class="result" style="display:none;"></div>
        </div>

        <div class="card">
            <h2>üß™ Test 2: Upload Test Image</h2>
            <div class="input-group">
                <label>Select a test image (JPG, PNG, etc.):</label>
                <input type="file" id="test-file" accept="image/*" />
            </div>
            <button class="btn" onclick="testUpload()" id="upload-btn" disabled>
                üì§ Upload Test Image
            </button>
            <div id="upload-status"></div>
            <div id="upload-result" class="result" style="display:none;"></div>
        </div>

        <div class="card">
            <h2>üîß Quick Fix Commands</h2>
            <p style="color: #cbd5e1; margin-bottom: 15px;">
                If tests fail, run these SQL commands in 
                <a href="https://supabase.com/dashboard/project/iuuhmkyyalrutbciwwwv/sql/new" target="_blank" style="color: #60a5fa;">SQL Editor</a>:
            </p>
            <button class="btn" onclick="copyFixSQL()">
                üìã Copy Fix SQL
            </button>
            <div id="fix-result" class="result" style="display:none;"></div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://iuuhmkyyalrutbciwwwv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1dWhta3l5YWxydXRiY2l3d3d2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1MDAyODksImV4cCI6MjA4NzA3NjI4OX0.KdBSO5Ge463-XA18ej-Zv4n0Gke8IHpYmUtuU9cXwHg';
        const BUCKET_NAME = 'product-images';

        // Display config
        document.getElementById('project-id').textContent = 'iuuhmkyyalrutbciwwwv';

        // Enable upload button when file selected
        document.getElementById('test-file').addEventListener('change', function() {
            document.getElementById('upload-btn').disabled = !this.files || this.files.length === 0;
        });

        async function testBucket() {
            const statusDiv = document.getElementById('bucket-status');
            const resultDiv = document.getElementById('bucket-result');
            
            statusDiv.innerHTML = '<div class="status pending">‚è≥ Testing bucket connection...</div>';
            resultDiv.style.display = 'none';

            try {
                // Test 1: Check if bucket exists
                const listResponse = await fetch(`${SUPABASE_URL}/storage/v1/bucket/${BUCKET_NAME}`, {
                    headers: {
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'apikey': SUPABASE_KEY
                    }
                });

                const listData = await listResponse.json();
                
                if (listResponse.ok) {
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Bucket exists and is accessible!</div>';
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '<pre>' + JSON.stringify({
                        status: 'success',
                        message: 'Bucket is accessible',
                        bucket: BUCKET_NAME,
                        public: listData.public,
                        fileSizeLimit: listData.file_size_limit
                    }, null, 2) + '</pre>';
                    resultDiv.style.display = 'block';
                } else {
                    throw new Error(listData.message || 'Bucket not accessible');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Bucket test failed!</div>';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '<pre>' + JSON.stringify({
                    status: 'error',
                    message: error.message,
                    bucket: BUCKET_NAME,
                    possibleFix: '1. Make sure bucket name is exactly "product-images"\n2. Bucket must be PUBLIC\n3. Run the Fix SQL from below'
                }, null, 2) + '</pre>';
                resultDiv.style.display = 'block';
            }
        }

        async function testUpload() {
            const fileInput = document.getElementById('test-file');
            const file = fileInput.files[0];
            if (!file) return;

            const statusDiv = document.getElementById('upload-status');
            const resultDiv = document.getElementById('upload-result');
            
            statusDiv.innerHTML = '<div class="status pending">‚è≥ Uploading test image...</div>';
            resultDiv.style.display = 'none';

            try {
                const fileName = `test-${Date.now()}-${file.name}`;
                
                const uploadResponse = await fetch(
                    `${SUPABASE_URL}/storage/v1/object/${BUCKET_NAME}/${fileName}`,
                    {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        },
                        body: file
                    }
                );

                const uploadData = await uploadResponse.json();

                if (uploadResponse.ok) {
                    const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/${BUCKET_NAME}/${fileName}`;
                    
                    statusDiv.innerHTML = '<div class="status success">‚úÖ Upload successful!</div>';
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = '<pre>' + JSON.stringify({
                        status: 'success',
                        message: 'Image uploaded successfully',
                        fileName: fileName,
                        publicUrl: publicUrl,
                        size: file.size,
                        type: file.type
                    }, null, 2) + '</pre>';
                    resultDiv.style.display = 'block';

                    // Try to delete the test file
                    try {
                        await fetch(`${SUPABASE_URL}/storage/v1/object/${BUCKET_NAME}/${fileName}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY
                            }
                        });
                    } catch (e) {
                        console.log('Cleanup:', e.message);
                    }
                } else {
                    throw new Error(uploadData.message || 'Upload failed');
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="status error">‚ùå Upload failed!</div>';
                resultDiv.className = 'result error';
                resultDiv.innerHTML = '<pre>' + JSON.stringify({
                    status: 'error',
                    message: error.message,
                    bucket: BUCKET_NAME,
                    fileName: file.name,
                    fileSize: file.size,
                    possibleFix: '1. Check bucket policies in Supabase Dashboard\n2. Bucket must allow public INSERT\n3. Run the Fix SQL from below'
                }, null, 2) + '</pre>';
                resultDiv.style.display = 'block';
            }
        }

        function copyFixSQL() {
            const sql = `-- Fix Storage Policies
-- Run in: https://supabase.com/dashboard/project/iuuhmkyyalrutbciwwwv/sql/new

-- First, verify bucket exists in Storage Dashboard
-- Bucket name must be exactly: product-images

-- Drop old policies
DROP POLICY IF EXISTS "Allow public uploads" ON storage.objects;
DROP POLICY IF EXISTS "Allow public read" ON storage.objects;
DROP POLICY IF EXISTS "Allow public update" ON storage.objects;
DROP POLICY IF EXISTS "Allow public delete" ON storage.objects;

-- Create new permissive policies
CREATE POLICY "Allow public uploads"
  ON storage.objects FOR INSERT
  TO authenticated, anon
  WITH CHECK (bucket_id = 'product-images');

CREATE POLICY "Allow public read"
  ON storage.objects FOR SELECT
  TO authenticated, anon
  USING (bucket_id = 'product-images');

CREATE POLICY "Allow public update"
  ON storage.objects FOR UPDATE
  TO authenticated, anon
  USING (bucket_id = 'product-images');

CREATE POLICY "Allow public delete"
  ON storage.objects FOR DELETE
  TO authenticated, anon
  USING (bucket_id = 'product-images');

-- ‚úÖ Try uploading again!`;

            navigator.clipboard.writeText(sql).then(() => {
                const resultDiv = document.getElementById('fix-result');
                resultDiv.className = 'result success';
                resultDiv.innerHTML = '<pre style="color: #4ade80;">‚úÖ SQL copied to clipboard!\n\nNow paste it in Supabase SQL Editor and run it.</pre>';
                resultDiv.style.display = 'block';
            });
        }
    </script>
</body>
</html>
